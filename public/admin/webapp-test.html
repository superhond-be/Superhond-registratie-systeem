<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <title>üê∂ Superhond ‚Äì Google Sheets WebApp test</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font:14px/1.5 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif; margin:2rem auto; max-width:980px; padding:0 1rem; }
    h1 { margin-bottom:.25rem; }
    .muted { color:#64748b; }
    .card { border:1px solid #e5e7eb; border-radius:10px; padding:1rem; margin:1rem 0; background:#fff; }
    input[type=url]{width:100%;padding:10px;border:1px solid #cbd5e1;border-radius:8px;}
    button{border:1px solid #cbd5e1;background:#fff;border-radius:8px;padding:7px 12px;cursor:pointer}
    button.primary{background:#1d4ed8;color:#fff;border-color:#1d4ed8}
    button.ghost{background:#f8fafc}
    button+button{margin-left:.4rem}
    table{width:100%;border-collapse:collapse;margin-top:.5rem}
    th,td{padding:7px 9px;border-bottom:1px solid #e5e7eb;font-size:13px;vertical-align:top}
    th:nth-child(1){width:120px}
    th:nth-child(2){width:260px}
    th:nth-child(3){width:130px}
    td.right{text-align:right;white-space:nowrap}
    pre{background:#0b1020;color:#d1e7ff;padding:1rem;border-radius:10px;min-height:140px;overflow:auto}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;color:#fff}
    .ok{background:#2ca34a}.err{background:#d64545}.warn{background:#e6a700}
    code{background:#f1f5f9;border-radius:4px;padding:0 .25rem}
  </style>
</head>
<body>
<h1>üê∂ Superhond ‚Äì Google Sheets WebApp test</h1>
<p class="muted">Test of je Google Apps Script WebApp (Sheets API) publiek bereikbaar is en JSON teruggeeft. Zet de deployment op <strong>Iedereen (zelfs anoniem)</strong> en gebruik de <strong>/exec</strong>-URL.</p>

<section class="card">
  <label for="url">WebApp-URL (eindigend op <code>/exec</code>)</label>
  <input id="url" type="url" placeholder="https://script.google.com/macros/s/‚Ä¶/exec" spellcheck="false">
  <div style="margin-top:8px">
    <button id="save" class="primary">üíæ Opslaan</button>
    <button id="run">üîç Verbinding testen</button>
    <button id="loadcfg" class="ghost">üåê Config laden</button>
    <button id="copy" class="ghost">üìã Kopieer URL</button>
    <button id="clear" class="ghost">üßπ Log wissen</button>
  </div>
  <p id="hint" class="muted" style="margin-top:.4rem"></p>
</section>

<section class="card">
  <h3>Status</h3>
  <table>
    <thead>
      <tr><th>Route</th><th>Pad</th><th>Endpoint</th><th class="right">Resultaat</th></tr>
    </thead>
    <tbody id="status"><tr><td colspan="4" class="muted">Nog geen test uitgevoerd.</td></tr></tbody>
  </table>
</section>

<section class="card">
  <h3>Log</h3>
  <pre id="log"></pre>
</section>

<script>
(() => {
  const els = {
    url:document.getElementById('url'),
    save:document.getElementById('save'),
    run:document.getElementById('run'),
    loadcfg:document.getElementById('loadcfg'),
    copy:document.getElementById('copy'),
    clear:document.getElementById('clear'),
    status:document.getElementById('status'),
    log:document.getElementById('log'),
    hint:document.getElementById('hint')
  };

  const LSKEY='superhond_api_base';
  const TIMEOUT=12000;
  const USE_PROXY=false; // zet true zodra je serverproxy klaar is

  // Prefill URL: QS ‚Üí LS ‚Üí /api/config
  const qs=new URLSearchParams(location.search);
  const fromQS=(qs.get('apiBase')||'').trim();
  const fromLS=(localStorage.getItem(LSKEY)||'').trim();

  async function getFromConfig(){
    try{
      const r=await ffetch('/api/config',4000);
      if(!r.ok) return '';
      const j=await r.json().catch(()=>({}));
      return String(j?.apiBase||'').trim();
    }catch{ return ''; }
  }

  function looksLikeExec(u){
    try{
      const x=new URL(u);
      return x.hostname==='script.google.com' && x.pathname.startsWith('/macros/s/') && x.pathname.endsWith('/exec');
    }catch{ return false; }
  }

  (async ()=>{
    let base = fromQS || fromLS || await getFromConfig() || '';
    if (fromQS) { try{ localStorage.setItem(LSKEY, fromQS); }catch{} }
    els.url.value = base;

    els.hint.textContent = base
      ? (looksLikeExec(base) ? '‚úÖ Geldige /exec URL gedetecteerd.' : '‚ö†Ô∏è URL lijkt geen geldige /exec te zijn.')
      : '‚ÑπÔ∏è Vul je /exec URL in of klik ‚ÄúConfig laden‚Äù om de serverinstelling te gebruiken.';
  })();

  // URL builders
  const RAW =(m,b)=>`${b}?mode=${encodeURIComponent(m)}&t=${Date.now()}`;
  const AO_RAW=(m,b)=>`https://api.allorigins.win/raw?url=${encodeURIComponent(RAW(m,b))}`;
  const AO_GET=(m,b)=>`https://api.allorigins.win/get?url=${encodeURIComponent(RAW(m,b))}`;
  const JINA  =(m,b)=>`https://r.jina.ai/http://${RAW(m,b).replace(/^https?:\\/\\//,'')}`;
  const PROXY =(m)=>`/api/sheets?mode=${encodeURIComponent(m)}&t=${Date.now()}`;

  const strip=s=>String(s||'').replace(/^\\uFEFF/,'').trim();
  const isHTML=t=>/^\\s*</.test(strip(t));
  const log=t=>{els.log.textContent+=t+'\\n';els.log.scrollTop=els.log.scrollHeight;};
  const row=(route,prefix,ep,resHtml)=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${route}</td><td><code>${prefix}</code></td><td><code>${ep}</code></td><td class="right">${resHtml}</td>`;
    els.status.appendChild(tr);
  };

  async function ffetch(u,ms=TIMEOUT){
    const ac=new AbortController();const to=setTimeout(()=>ac.abort(),ms);
    try{return await fetch(u,{cache:'no-store',signal:ac.signal});}
    finally{clearTimeout(to);}
  }

  function parse(t,wrap=false){
    const s=strip(t);
    if(isHTML(s)) throw new Error('HTML ontvangen (login of foutpagina)');
    if(!wrap) return JSON.parse(s);
    const j=JSON.parse(s);
    const c=strip(j.contents||'');
    if(isHTML(c)) throw new Error('AllOrigins-get gaf HTML');
    return JSON.parse(c);
  }

  async function tryOne(kind,url,wrap,mode){
    const basePrefix = url.split('?')[0];
    try{
      const r=await ffetch(url);
      const txt=await r.text();
      if(!r.ok) throw new Error(`HTTP ${r.status}`);
      const j=parse(txt,wrap);
      row(kind,basePrefix,mode,`<span class="pill ok">OK</span> <small>${r.status}</small>`);
      log(`‚úÖ ${mode}: ${kind} OK (${r.status})`);
      return j;
    }catch(e){
      row(kind,basePrefix,mode,`<span class="pill err">Fout</span> <small>${e.message}</small>`);
      log(`‚ùå ${mode}: ${kind} ‚Üí ${e.message}`);
      throw e;
    }
  }

  async function testAll(base,mode){
    const steps=[
      {n:'direct',url:RAW(mode,base)},
      {n:'AO-raw',url:AO_RAW(mode,base)},
      {n:'AO-get',url:AO_GET(mode,base),wrap:true},
      {n:'Jina',url:JINA(mode,base)},
      ...(USE_PROXY?[{n:'proxy',url:PROXY(mode)}]:[])
    ];
    for(const s of steps){
      try{ await tryOne(s.n,s.url,!!s.wrap,mode); return true; }
      catch(_){ /* ga naar volgende */ }
    }
    throw new Error(`${mode}: geen enkele route werkte`);
  }

  async function runTest(){
    const base=els.url.value.trim();
    if(!base){alert('Vul je /exec URL in');return;}
    if(!looksLikeExec(base) && !confirm('Deze URL lijkt niet te eindigen op /exec of is geen script.google.com.\nToch testen?')) return;

    localStorage.setItem(LSKEY,base);
    els.status.innerHTML='';
    els.log.textContent='';

    // 1) ping
    try{await testAll(base,'ping');}
    catch(e){log('üö´ Ping faalde overal. Controleer rechten of netwerk.');return;}

    // 2) data-endpoints
    const endpoints = ['klanten','honden','klassen','lessenreeksen','lessen'];
    for (const ep of endpoints) {
      try { await testAll(base, ep); log(`‚úÖ ${ep} OK`); }
      catch(e){ log(`‚ùå ${ep} fout: ${e.message}`); }
    }

    log('\\n‚Äî Test klaar ‚Äî');
    log('‚ÑπÔ∏è Als Jina of AllOrigins werkt maar direct niet ‚Üí CORS (gebruik dan je proxy /api/sheets in de app).');
  }

  // UI events
  els.save.onclick=()=>{
    const v=els.url.value.trim();
    localStorage.setItem(LSKEY,v);
    els.hint.textContent = v
      ? (looksLikeExec(v) ? '‚úÖ Opgeslagen. Geldige /exec URL.' : '‚ö†Ô∏è Opgeslagen, maar deze URL lijkt geen geldige /exec te zijn.')
      : '‚ÑπÔ∏è Lege URL opgeslagen. Vul een /exec in om te testen.';
    log('üíæ Opgeslagen');
  };
  els.run.onclick=runTest;
  els.clear.onclick=()=>{els.log.textContent='';};
  els.copy.onclick=async()=>{
    try{await navigator.clipboard.writeText(els.url.value.trim()); log('üìã URL gekopieerd');}
    catch{log('‚ö†Ô∏è Kon URL niet kopi√´ren');}
  };
  els.loadcfg.onclick=async()=>{
    const cfg=await getFromConfig();
    if(cfg){
      els.url.value=cfg;
      localStorage.setItem(LSKEY,cfg);
      els.hint.textContent = looksLikeExec(cfg) ? '‚úÖ Config geladen (server) ‚Äî geldige /exec' : '‚ö†Ô∏è Config geladen, maar lijkt geen geldige /exec';
      log('üåê Config geladen uit /api/config');
    }else{
      log('‚ö†Ô∏è Geen apiBase in /api/config gevonden');
    }
  };
})();
</script>
</body>
</html>
