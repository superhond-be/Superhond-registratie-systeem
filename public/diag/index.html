<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Superhond ‚Äì Diagnose</title>
  <link rel="stylesheet" href="../css/style.css?v=diag" />
  <link rel="stylesheet" href="../css/superhond.css?v=diag" />
  <style>
    body { background:#f6f8fb }
    .wrap { max-width: 980px; margin: 16px auto; padding: 16px }
    .grid { display:grid; gap:8px }
    .row  { display:grid; grid-template-columns: 190px 1fr; gap:8px; align-items:center }
    .ok { color:#16a34a; font-weight:700 }
    .err{ color:#b91c1c; font-weight:700 }
    code.small { font-size:.85em; word-break:break-all }
    table.table td:nth-child(1){white-space:nowrap}
  </style>

  <!-- (optioneel) als je de exec hier al wil vastzetten: -->
  <!--
  <script>
    window.SUPERHOND_SHEETS_URL = 'https://script.google.com/macros/s/XXXXX/exec';
  </script>
  -->
</head>
<body class="subpage">
  <header id="topbar"></header>

  <main class="wrap card">
    <h1 style="margin:0 0 12px">ü©∫ Diagnose</h1>

    <div class="grid" style="margin:6px 0 12px">
      <div class="row">
        <label for="exec" class="muted">GAS /exec URL</label>
        <input id="exec" class="input" placeholder="https://script.google.com/macros/s/‚Ä¶/exec" />
      </div>
      <div class="row">
        <span></span>
        <div class="toolbar">
          <button id="btn-save"   class="btn">üíæ Gebruik & opslaan</button>
          <button id="btn-clear"  class="btn">üßπ Cache wissen</button>
          <button id="btn-run"    class="btn">‚ñ∂Ô∏è Test opnieuw</button>
        </div>
      </div>
    </div>

    <table class="table" id="tbl">
      <thead>
        <tr><th>Stap</th><th>Status</th><th>Opmerking</th></tr>
      </thead>
      <tbody></tbody>
    </table>

    <p class="muted" style="margin-top:10px">
      Tip: na ‚Äúüßπ Cache wissen‚Äù herlaad je best met <kbd>Cmd/Ctrl</kbd> + <kbd>Shift</kbd> + <kbd>R</kbd>.
    </p>
  </main>

  <footer id="footer"></footer>

  <script defer src="../js/layout.js?v=0.24.3-noapi"></script>

  <script type="module">
    import { initFromConfig, setBaseUrl, getBaseUrl, fetchSheet } from '../js/sheets.js';

    // Topbar mount
    document.addEventListener('DOMContentLoaded', () => {
      window.SuperhondUI?.mount?.({ title:'Diagnose', icon:'ü©∫', back:'../dashboard/' });
    });

    const $ = (s,r=document)=>r.querySelector(s);
    const tbody = $('#tbl tbody');
    const execInput = $('#exec');
    const btnSave = $('#btn-save');
    const btnRun  = $('#btn-run');
    const btnClear= $('#btn-clear');

    function row(step, ok, note=''){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${step}</td>
        <td class="${ok?'ok':'err'}">${ok?'OK':'ERR'}</td>
        <td><code class="small">${String(note || '').slice(0,800)}</code></td>`;
      tbody.appendChild(tr);
    }

    function resolveExecFromPage(){
      if (typeof window.SUPERHOND_SHEETS_URL === 'string' && window.SUPERHOND_SHEETS_URL) {
        return window.SUPERHOND_SHEETS_URL;
      }
      const meta = document.querySelector('meta[name="superhond-exec"]');
      return meta?.content || '';
    }

    async function pingDirect(base){
      if (!base) return { ok:false, msg:'Geen base-URL' };
      const url = base + (base.includes('?') ? '&' : '?') + 'mode=ping&t=' + Date.now();
      try{
        const r = await fetch(url, { cache:'no-store' });
        const txt = await r.text();
        return { ok: r.ok, msg: `HTTP ${r.status} ‚Äî ${txt.slice(0,120)}` };
      }catch(e){
        return { ok:false, msg: String(e) };
      }
    }

    async function run(){
      tbody.innerHTML = '';

      // 1) Ophalen huidige exec (volgorde: setBaseUrl -> window -> meta)
      await initFromConfig().catch(()=>{});
      let base = getBaseUrl() || resolveExecFromPage();
      row('Basis-URL', !!base, base || '‚Äî');

      // 2) Ping direct
      if (base){
        const p = await pingDirect(base);
        row('GAS ping', p.ok, p.msg);
      } else {
        row('GAS ping', false, 'Geen base-URL ingesteld');
      }

      // 3) Klanten
      try{
        const k = await fetchSheet('Klanten');
        row('Sheet:Klanten', true, `Rijen: ${k?.length ?? 0}`);
      }catch(e){
        row('Sheet:Klanten', false, e?.message || String(e));
      }

      // 4) Honden
      try{
        const h = await fetchSheet('Honden');
        row('Sheet:Honden', true, `Rijen: ${h?.length ?? 0}`);
      }catch(e){
        row('Sheet:Honden', false, e?.message || String(e));
      }
    }

    // UI events
    btnSave.addEventListener('click', () => {
      const v = execInput.value.trim();
      if (!v) { alert('Vul een geldige /exec-URL in.'); return; }
      setBaseUrl(v);   // bewaart ook in localStorage
      run();
    });

    btnRun.addEventListener('click', run);

    btnClear.addEventListener('click', () => {
      try { localStorage.removeItem('superhond:apiBase'); } catch {}
      alert('Cache gewist. Herlaad de pagina (Cmd/Ctrl + Shift + R) voor een schone start.');
    });

    // Prefill input en initiale run
    document.addEventListener('DOMContentLoaded', () => {
      execInput.value = getBaseUrl() || resolveExecFromPage();
      run();
    });
  </script>
</body>
</html>
