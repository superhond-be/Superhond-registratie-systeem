<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Superhond â€“ Google Sheets test</title>
  <style>
    body {
      font-family: system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      max-width: 960px; margin: 2rem auto; padding: 0 1rem;
      background:#fafafa;
    }
    h1 {margin-bottom:.5rem;}
    .card {
      background:#fff; border:1px solid #e5e7eb; border-radius:10px;
      padding:12px; margin:12px 0;
    }
    .ok{color:#047857} .err{color:#b91c1c} .muted{color:#6b7280}
    pre {
      background:#0b1220; color:#d1e7ff; border-radius:8px;
      padding:10px; overflow:auto; max-height:240px;
    }
    .btn {
      border:1px solid #d1d5db; background:#fff;
      border-radius:6px; padding:.4rem .8rem; cursor:pointer;
    }
    input[type=text] {
      width:100%; padding:.4rem; border:1px solid #d1d5db; border-radius:6px;
    }
    #statusbar {
      margin-top:1rem; padding:.5rem .7rem; border-radius:6px;
      background:#f9fafb; border:1px solid #e5e7eb;
    }
    #logArea {
      background:#0b1220; color:#d1e7ff;
      border-radius:8px; padding:8px; height:160px; overflow:auto; margin:0;
    }
  </style>
</head>
<body>
  <h1>ğŸ¶ Superhond â€“ Google Sheets web-app test</h1>
  <p class="muted">Verifieer of je Apps Script Web App goed werkt en alle tabbladen bereikbaar zijn.</p>

  <!-- ğŸ“¡ Instellingen -->
  <section class="card" id="settings">
    <h2>âš™ï¸ Instellingen & Controle</h2>

    <div style="margin-bottom:1rem">
      <label for="inputUrl"><strong>ğŸ“¡ Web-app URL</strong></label><br>
      <input id="inputUrl" type="text" placeholder="https://script.googleusercontent.com/... of https://script.google.com/.../exec" />
      <button class="btn" id="btn-save-url">ğŸ’¾ Opslaan</button>
      <button class="btn" id="btn-test-url">ğŸ” Verbinding testen</button>
      <span id="pingMsg" class="muted"></span>
    </div>

    <div style="margin-bottom:1rem">
      <button class="btn" id="btn-reload">ğŸ”„ Opnieuw laden (via Sheets)</button>
      <button class="btn" id="btn-recheck">âœ… Controle opnieuw uitvoeren</button>
    </div>

    <label><input type="checkbox" id="chk-empty" checked> Controleer op lege cellen</label><br>
    <label><input type="checkbox" id="chk-cols" checked> Controleer op ontbrekende kolommen</label>

    <div id="statusbar">
      <span id="statusText" class="muted">Nog geen controle uitgevoerd.</span>
    </div>
  </section>

  <div id="root"></div>

  <!-- ğŸªµ Logboek -->
  <section class="card" id="console">
    <h2>ğŸªµ Logboek</h2>
    <pre id="logArea"></pre>
    <div style="display:flex;gap:.5rem;margin-top:.5rem;flex-wrap:wrap">
      <button class="btn" id="btn-clear-log">ğŸ§¹ Wissen</button>
      <button class="btn" id="btn-download-log">ğŸ’¾ Download log</button>
    </div>
  </section>

  <script>
    // ===== BASISINSTELLING =====
    const SHEETS = ["Klassen","Klanten","Honden","Lessenreeksen","Lessen"];
    const root = document.getElementById('root');
    const inputUrl = document.getElementById("inputUrl");
    const saveMsg = document.getElementById("pingMsg");
    const statusText = document.getElementById("statusText");
    const logArea = document.getElementById("logArea");

    let BASE = "";
    const cache = new Map();

    // ===== LOGFUNCTIES =====
    function log(msg,type="info"){
      const t=new Date().toLocaleTimeString("nl-BE",{hour12:false});
      const p=type==="error"?"âŒ":type==="warn"?"âš ï¸":"â„¹ï¸";
      logArea.textContent += `[${t}] ${p} ${msg}\n`;
      logArea.scrollTop = logArea.scrollHeight;
    }
    document.getElementById("btn-clear-log").onclick=()=>logArea.textContent="";
    document.getElementById("btn-download-log").onclick=()=>{
      const blob=new Blob([logArea.textContent||""],{type:"text/plain;charset=utf-8"});
      const url=URL.createObjectURL(blob);
      const a=document.createElement("a");
      const stamp=new Date().toISOString().replace(/[:.]/g,"-").slice(0,19);
      a.href=url; a.download=`superhond-log-${stamp}.txt`;
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
      URL.revokeObjectURL(url);
      log("Logboek gedownload als superhond-log.txt");
    };

    // ===== URL OPSLAAN / LADEN =====
    function setBaseUrl(url){ BASE=url.replace(/\/$/,""); }
    const saved=localStorage.getItem("superhond_exec_url");
    if(saved){ inputUrl.value=saved; setBaseUrl(saved); log("Web-app URL geladen uit opslag"); }

    document.getElementById("btn-save-url").onclick=()=>{
      const val=inputUrl.value.trim();
      // âœ… accepteer beide varianten
      if(!val.startsWith("https://script.google.com/macros/") &&
         !val.startsWith("https://script.googleusercontent.com/")){
        saveMsg.textContent="âš ï¸ Ongeldige URL"; 
        saveMsg.style.color="#b91c1c";
        return;
      }
      localStorage.setItem("superhond_exec_url",val);
      setBaseUrl(val);
      saveMsg.textContent="âœ… Opgeslagen!";
      saveMsg.style.color="#047857";
      log("Nieuwe Web-app URL opgeslagen");
      setTimeout(()=>saveMsg.textContent="",2500);
    };

    // ===== VERBINDING TESTEN =====
    document.getElementById("btn-test-url").onclick=async()=>{
      const val=inputUrl.value.trim();
      if(!val){ saveMsg.textContent="âš ï¸ Geen URL ingevuld"; saveMsg.style.color="#b91c1c"; return; }
      saveMsg.textContent="ğŸ”„ Testenâ€¦"; saveMsg.style.color="#6b7280"; log("Verbindingstest gestartâ€¦");
      try{
        const r=await fetch(val+(val.includes("?")?"&":"?")+"ping=1",{method:"GET",mode:"cors"});
        const j=await r.json();
        if(j.ok&&j.pong){ saveMsg.textContent="âœ… Verbinding OK"; saveMsg.style.color="#047857"; log("Verbinding OK"); }
        else { saveMsg.textContent="âš ï¸ Ongeldig antwoord"; saveMsg.style.color="#b45309"; log("Verbinding gaf ongeldig antwoord","warn"); }
      }catch(e){
        saveMsg.textContent="âŒ Geen verbinding"; saveMsg.style.color="#b91c1c"; log("Geen verbinding met Web App","error");
      }
      setTimeout(()=>saveMsg.textContent="",5000);
    };

    // ===== HULPFUNCTIES =====
    function card(title,html){
      const div=document.createElement("div");
      div.className="card";
      div.innerHTML=`<h3 style="margin:0 0 .5rem">${title}</h3>${html}`;
      root.appendChild(div);
    }
    function updateStatusbar(results){
      if(!results||!results.length){
        statusText.textContent="Nog geen controle uitgevoerd.";
        statusText.style.color="#6b7280"; return;
      }
      const total=results.length;
      const ok=results.filter(m=>m.startsWith("âœ…")).length;
      const warn=total-ok;
      statusText.textContent=`ğŸ“Š ${total} tabbladen gecontroleerd â€” âœ… ${ok} OK â€¢ âš ï¸ ${warn} waarschuwing(en)`;
      statusText.style.color=warn?"#b91c1c":"#047857";
    }
    function validateSheet(name,items,requiredCols=[]){
      const msgs=[];
      if(!Array.isArray(items)||items.length===0){
        msgs.push(`âš ï¸ Geen rijen gevonden in ${name}`); return msgs;
      }
      const first=items[0];
      for(const col of requiredCols)
        if(!(col in first)) msgs.push(`âš ï¸ Kolom '${col}' ontbreekt in ${name}`);
      if(msgs.length===0) msgs.push(`âœ… ${name} ok`);
      return msgs;
    }

    // ===== DATA LADEN =====
    async function loadAll(){
      root.innerHTML="";
      if(!BASE){ alert("Geen Web-app URL ingesteld."); return; }
      const results=[];
      for(const name of SHEETS){
        const url=`${BASE}?sheet=${encodeURIComponent(name)}&t=${Date.now()}`;
        log(`Laden van ${name}â€¦`);
        try{
          const r=await fetch(url,{cache:"no-store",mode:"cors"});
          const j=await r.json();
          const items=Array.isArray(j?.items)?j.items:[];
          cache.set(name,items);
          const msgs=validateSheet(name,items,["id","naam","status"]);
          results.push(...msgs);
          const cnt=items.length;
          card(`Sheet: ${name} <span class="ok">(${cnt} records)</span>`,
               cnt?`<pre>${JSON.stringify(items.slice(0,3),null,2)}</pre>`:
               `<div class="muted">Leeg of geen records</div>`);
          log(`${name}: ${cnt} records geladen`);
        }catch(e){
          card(`Sheet: ${name} <span class="err">(fout)</span>`,
               `<div class="err">Fout: ${e.message || "Load failed"}</div>`);
          log(`${name}: fout ${e.message || "Load failed"}`,"error");
        }
      }
      updateStatusbar(results);
      log("Alle tabbladen verwerkt âœ…");
    }

    // ===== CONTROLE OPNIEUW =====
    async function recheckAll(){
      const chkCols=document.getElementById("chk-cols").checked;
      const results=[];
      for(const name of SHEETS){
        const items=cache.get(name);
        if(!items){ log(`Geen cache voor ${name}`,"warn"); continue; }
        const msgs=validateSheet(name,items,chkCols?["id","naam","status"]:[]);
        results.push(...msgs);
      }
      updateStatusbar(results);
      log("Controle opnieuw uitgevoerd");
    }

    // knoppen
    document.getElementById("btn-reload").onclick=()=>{ log("Opnieuw laden gestartâ€¦"); loadAll(); };
    document.getElementById("btn-recheck").onclick=recheckAll;
  </script>
</body>
</html>
