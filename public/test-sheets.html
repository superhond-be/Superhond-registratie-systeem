<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <title>üê∂ Superhond ‚Äî Google Sheets Web-App test</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --bg:#0b1020; --fg:#d1e7ff; --ok:#2ca34a; --warn:#e6a700; --err:#d64545; }
    body { font:14px/1.5 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif; max-width:980px; margin:24px auto; padding:0 12px; }
    h1,h2,h3 { margin:.25rem 0 .5rem; }
    .card { border:1px solid #e5e7eb; border-radius:10px; padding:14px; margin:14px 0; }
    label { font-weight:600; display:block; margin:8px 0 6px; }
    input[type=url] { width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:8px; }
    .row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-top:8px; }
    button { border:1px solid #cbd5e1; background:#fff; border-radius:8px; padding:8px 12px; cursor:pointer; }
    button.primary { background:#1d4ed8; color:#fff; border-color:#1d4ed8; }
    button.ghost { background:#f8fafc; }
    .muted { color:#64748b; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; color:#fff; }
    .ok { background:var(--ok); } .warn { background:var(--warn); } .err { background:var(--err); } .info { background:#3a7bd5; }
    pre.log { background:var(--bg); color:var(--fg); padding:12px; border-radius:10px; min-height:160px; overflow:auto; }
    table { width:100%; border-collapse:collapse; }
    th,td { border-bottom:1px solid #e5e7eb; padding:8px; font-size:13px; vertical-align:top; }
    th:nth-child(1), td:nth-child(1) { width:130px; }
    th:nth-child(2), td:nth-child(2) { width:110px; }
    td.right, th.right { text-align:right; white-space:nowrap; }
    code { background:#f1f5f9; padding:2px 6px; border-radius:6px; }
    details > summary { cursor:pointer; }
  </style>
</head>
<body>
  <h1>üê∂ Superhond ‚Äî Google Sheets Web-App test</h1>
  <p class="muted">Controleer of jouw Apps Script Web-App publiek bereikbaar is en via de browser **leesbaar** is (CORS/JSON). Dit is 100% los van je hoofdapp ‚Äî ideaal om snel problemen te isoleren.</p>

  <section class="card">
    <h2>Instellingen &amp; Controle</h2>
    <label for="u">Web-app URL (je <code>/exec</code>)</label>
    <input id="u" type="url" placeholder="https://script.google.com/macros/s/‚Ä¶/exec">
    <div class="row">
      <button id="save" class="primary">üíæ Opslaan</button>
      <button id="test">üîç Verbinding testen</button>
      <button id="recheck" class="ghost">üß™ Alleen opnieuw controleren</button>
      <button id="clear" class="ghost">üßπ Log wissen</button>
      <button id="dl" class="ghost">‚¨áÔ∏è Log downloaden</button>
    </div>
    <p class="muted" style="margin-top:6px">
      Tip: deploy de Web-App als <strong>Anyone (even anonymous)</strong> en gebruik de echte <code>/exec</code>-URL.
      Je kunt ook deze pagina openen met <code>?apiBase=‚Ä¶</code> om het veld automatisch te vullen.
    </p>
  </section>

  <section class="card">
    <h3>Status</h3>
    <table>
      <thead><tr><th>Stap</th><th>Pad</th><th>Endpoint</th><th class="right">Resultaat</th></tr></thead>
      <tbody id="statusBody">
        <tr><td colspan="4" class="muted">Nog geen controle uitgevoerd.</td></tr>
      </tbody>
    </table>
  </section>

  <section class="card">
    <h3>Logboek</h3>
    <pre class="log" id="log"></pre>
  </section>

<script>
(() => {
  // ==== CONFIG ====
  const els = {
    u: document.getElementById('u'),
    save: document.getElementById('save'),
    test: document.getElementById('test'),
    recheck: document.getElementById('recheck'),
    clear: document.getElementById('clear'),
    dl: document.getElementById('dl'),
    statusBody: document.getElementById('statusBody'),
    log: document.getElementById('log'),
  };
  const LSKEY = 'superhond_api_base';
  const USE_PROXY = false; // zet true als je /api/sheets proxy hebt
  const TIMEOUT = 9000;

  // Build URLs
  const RAW  = (mode, base) => `${base}?mode=${encodeURIComponent(mode)}&t=${Date.now()}`;
  const AO_RAW = (mode, base) => `https://api.allorigins.win/raw?url=${encodeURIComponent(RAW(mode, base))}`;
  const AO_GET = (mode, base) => `https://api.allorigins.win/get?url=${encodeURIComponent(RAW(mode, base))}`;
  const PROXY  = (mode)      => `/api/sheets?mode=${encodeURIComponent(mode)}&t=${Date.now()}`;

  // ==== UTILS ====
  const stripBOM = s => String(s||'').replace(/^\uFEFF/, '').trim();
  const isHTML = txt => /^\s*</.test(stripBOM(txt));
  const qs = new URLSearchParams(location.search);
  const fromQS = qs.get('apiBase');

  function setStatusRow(step, path, endpoint, resultHTML) {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${step}</td><td><code>${path}</code></td><td><code>${endpoint}</code></td><td class="right">${resultHTML}</td>`;
    els.statusBody.appendChild(tr);
  }
  function resetStatus() {
    els.statusBody.innerHTML = '';
  }
  function log(line) {
    els.log.textContent += line + '\n';
    els.log.scrollTop = els.log.scrollHeight;
  }

  async function tfetch(url, ms = TIMEOUT) {
    const ac = ('AbortController' in window) ? new AbortController() : null;
    const t = ac ? setTimeout(() => ac.abort(), ms) : null;
    try {
      return await fetch(url, { cache:'no-store', signal: ac?.signal });
    } finally {
      if (t) clearTimeout(t);
    }
  }

  function parseMaybeWrapped(text, wrapped=false) {
    const s = stripBOM(text);
    if (isHTML(s)) throw new Error('HTML ontvangen (waarschijnlijk Google login of foutpagina).');
    if (!wrapped) return JSON.parse(s);
    const outer = JSON.parse(s);
    if (typeof outer?.contents !== 'string') throw new Error('AllOrigins(get) gaf geen contents.');
    const inner = stripBOM(outer.contents);
    if (isHTML(inner)) throw new Error('AllOrigins(get) contents bevat HTML (login).');
    return JSON.parse(inner);
  }

  async function tryStep(kind, url, wrapped=false) {
    const res = await tfetch(url);
    const text = await res.text();
    const http = res.status;
    if (!res.ok) throw new Error(`${kind}: HTTP ${http} ‚Äî ${text.slice(0,120)}`);
    const json = parseMaybeWrapped(text, wrapped);
    // accepteer {ok:true,data}, {data}, of array
    const data = Array.isArray(json) ? json : (json.data ?? null);
    return { http, json, data };
  }

  async function testEndpoint(base, mode) {
    // 1) Direct
    try {
      log(`‚Üí ${mode}: direct ${RAW(mode, base)}`);
      const { http, json } = await tryStep('direct', RAW(mode, base), false);
      setStatusRow('direct', 'fetch', mode, `<span class="pill ok">OK</span> <small>HTTP ${http}</small>`);
      log(`   ‚úÖ direct OK (HTTP ${http})`);
      return json;
    } catch (e1) {
      setStatusRow('direct', 'fetch', mode, `<span class="pill err">Fout</span> <small>${e1.message}</small>`);
      log(`   ‚ùå direct: ${e1.message}`);
    }

    // 2) AllOrigins raw
    try {
      log(`‚Üí ${mode}: allorigins/raw ${AO_RAW(mode, base)}`);
      const { http, json } = await tryStep('allorigins-raw', AO_RAW(mode, base), false);
      setStatusRow('allorigins', 'raw', mode, `<span class="pill ok">OK</span> <small>HTTP ${http}</small>`);
      log(`   ‚úÖ allorigins-raw OK (HTTP ${http})`);
      return json;
    } catch (e2) {
      setStatusRow('allorigins', 'raw', mode, `<span class="pill err">Fout</span> <small>${e2.message}</small>`);
      log(`   ‚ùå allorigins-raw: ${e2.message}`);
    }

    // 3) AllOrigins get (wrapped)
    try {
      log(`‚Üí ${mode}: allorigins/get ${AO_GET(mode, base)}`);
      const { http, json } = await tryStep('allorigins-get', AO_GET(mode, base), true);
      setStatusRow('allorigins', 'get', mode, `<span class="pill ok">OK</span> <small>HTTP ${http}</small>`);
      log(`   ‚úÖ allorigins-get OK (HTTP ${http})`);
      return json;
    } catch (e3) {
      setStatusRow('allorigins', 'get', mode, `<span class="pill err">Fout</span> <small>${e3.message}</small>`);
      log(`   ‚ùå allorigins-get: ${e3.message}`);
    }

    // 4) Server proxy (optioneel)
    if (USE_PROXY) {
      try {
        log(`‚Üí ${mode}: proxy ${PROXY(mode)}`);
        const { http, json } = await tryStep('proxy', PROXY(mode), false);
        setStatusRow('proxy', '/api/sheets', mode, `<span class="pill ok">OK</span> <small>HTTP ${http}</small>`);
        log(`   ‚úÖ proxy OK (HTTP ${http})`);
        return json;
      } catch (e4) {
        setStatusRow('proxy', '/api/sheets', mode, `<span class="pill err">Fout</span> <small>${e4.message}</small>`);
        log(`   ‚ùå proxy: ${e4.message}`);
      }
    }

    throw new Error(`Alle paden faalden voor ${mode}.`);
  }

  async function fullTest() {
    const base = els.u.value.trim();
    if (!base) { alert('Vul je /exec URL in.'); return; }
    resetStatus(); els.log.textContent = '';

    // PING eerst ‚Äî zo detecteren we login/permissions meteen
    try {
      const pingJson = await testEndpoint(base, 'ping');
      const ok = pingJson?.ok === true || pingJson?.data?.ok === true || String(pingJson?.data?.ping||'').toLowerCase() === 'ok';
      if (!ok) log('‚ö†Ô∏è Ping antwoordde zonder duidelijke ok-indicator.');
    } catch (e) {
      log('üö´ Ping faalde op alle paden. Waarschijnlijk CORS/HTML (login) of verkeerde deployment URL.');
      return;
    }

    // KLANTEN
    try {
      const kl = await testEndpoint(base, 'klanten');
      const arr = Array.isArray(kl?.data) ? kl.data : (Array.isArray(kl) ? kl : []);
      log(`üë§ Klanten: ${arr.length} rijen`);
      log(JSON.stringify(arr.slice(0, 5), null, 2));
    } catch (e) {
      log('‚ùå Klanten faalden: ' + e.message);
    }

    // HONDEN
    try {
      const ho = await testEndpoint(base, 'honden');
      const arr = Array.isArray(ho?.data) ? ho.data : (Array.isArray(ho) ? ho : []);
      log(`üê∂ Honden: ${arr.length} rijen`);
      log(JSON.stringify(arr.slice(0, 5), null, 2));
    } catch (e) {
      log('‚ùå Honden faalden: ' + e.message);
    }

    // Diagnose samenvatting
    const txt = els.statusBody.textContent;
    if (txt.includes('directOK') || txt.includes('OK')) {
      // noop; tabel heeft badges
    }
    log('\n‚Äî Klaar ‚Äî');
    log('üéØ Interpretatie:');
    log('‚Ä¢ Als "direct" vaak faalt maar "allorigins" OK is ‚ûú CORS; je hoofdapp zal via fallback/proxy moeten werken.');
    log('‚Ä¢ Als alles OK is ‚ûú Je kunt de directe URL in je app gebruiken.');
  }

  // ==== INIT ====
  // Prefill uit localStorage of querystring
  const saved = localStorage.getItem(LSKEY);
  els.u.value = fromQS || saved || '';

  // Events
  els.save.addEventListener('click', () => {
    const v = els.u.value.trim();
    localStorage.setItem(LSKEY, v);
    log('üíæ Opgeslagen: ' + v);
  });
  els.test.addEventListener('click', fullTest);
  els.recheck.addEventListener('click', () => { resetStatus(); fullTest(); });
  els.clear.addEventListener('click', () => els.log.textContent = '');
  els.dl.addEventListener('click', () => {
    const blob = new Blob([els.log.textContent], { type: 'text/plain' });
    const a = Object.assign(document.createElement('a'), { href: URL.createObjectURL(blob), download: 'webapp-test-log.txt' });
    document.body.appendChild(a); a.click(); a.remove();
  });
})();
</script>
</body>
</html>
