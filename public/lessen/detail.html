<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Les detail ‚Äì Superhond</title>
  <link rel="stylesheet" href="/css/style.css?v=0.20.0" />
  <style>
    .grid{display:grid;gap:1rem;grid-template-columns:1fr}
    @media (min-width: 900px){ .grid{grid-template-columns:1.2fr .8fr} }
    .chips{display:flex;gap:.25rem;flex-wrap:wrap}
    .chip{display:inline-flex;align-items:center;padding:.2rem .55rem;border:1px solid #e5e7eb;border-radius:999px;background:#fff}
    .meta{color:#6b7280}
  </style>
</head>
<body>
<header id="topbar" class="topbar"></header>

<main class="container">
  <h1 class="page-title">Les detail</h1>

  <div id="box" class="card">Laden‚Ä¶</div>

  <div class="grid" style="margin-top:1rem">
    <section class="card">
      <h3 style="margin-top:0">Informatie</h3>
      <table class="table">
        <tbody id="tbl"></tbody>
      </table>
    </section>

    <aside class="card">
      <h3 style="margin-top:0">Notities</h3>
      <div id="notes" class="meta">‚Äî</div>
    </aside>
  </div>

  <p style="margin-top:1rem"><a class="btn" href="/dashboard/">‚Üê Terug naar dashboard</a></p>
</main>

<footer id="footer" class="footer"></footer>

<script src="/js/layout.js?v=0.20.0"></script>
<script>
  // Gele balk + footer
  window.addEventListener('DOMContentLoaded', () => {
    window.SuperhondUI?.mount?.({ title:'Les detail', icon:'üìÖ', back:'/dashboard/' });
  });

  (function(){
    const params = new URLSearchParams(location.search);
    const id = params.get('id');

    const box = document.getElementById('box');
    const tbody = document.getElementById('tbl');
    const notes = document.getElementById('notes');

    const S = v => String(v ?? '');
    const pad2 = n => String(n).padStart(2,'0');
    const toDT = iso => iso ? new Date(iso) : null;
    const humanDate = iso => {
      const d = toDT(iso);
      if(!d || isNaN(+d)) return S(iso);
      return d.toLocaleString('nl-BE',{ dateStyle:'full', timeStyle:'short' });
    };
    const chip = t => `<span class="chip">${escapeHtml(t)}</span>`;
    const escapeHtml = s => S(s).replace(/[&<>\"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]));
    function buildMapsUrl(loc){
      if (!loc) return '';
      if (loc.mapsUrl) return loc.mapsUrl;
      const line1 = [loc.straat, loc.huisnr].filter(Boolean).join(' ');
      const line2 = [loc.postcode, loc.gemeente||loc.plaats].filter(Boolean).join(' ');
      const q = [line1, line2, loc.land||'BE'].filter(Boolean).join(', ');
      return q.trim() ? `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(q)}` : '';
    }

    async function fetchJson(url){
      const r = await fetch(url,{cache:'no-store'});
      if(!r.ok) throw new Error(`${url} ‚Üí HTTP ${r.status}`);
      return r.json();
    }

    async function loadAll(){
      // probeer API, anders data files
      const bust = `?t=${Date.now()}`;
      // lessen (minimaal), trainers, locaties, reeksen
      let lessen = [];
      try {
        const api = await fetchJson('/api/lessen'+bust);
        lessen = api.items || api || [];
      } catch {
        try { lessen = await fetchJson('/data/lessen.json'+bust); } catch {}
      }
      const [trainers, locaties, reeksen] = await Promise.all([
        fetchJson('/data/trainers.json'+bust).catch(()=>[]),
        fetchJson('/data/locaties.json'+bust).catch(()=>[]),
        fetchJson('/data/reeksen.json'+bust).catch(()=>[])
      ]);
      return { lessen, trainers, locaties, reeksen };
    }

    function firstNames(trainers){
      return (trainers||[]).map(t=>t.voornaam).filter(Boolean).join(', ');
    }

    (async function init(){
      if (!id){ box.innerHTML = '<p class="error">Geen id opgegeven.</p>'; return; }

      try{
        const all = await loadAll();

        // zoek les zowel op lesson.id als via agenda (fallback)
        let les = (all.lessen||[]).find(x => String(x.id) === String(id));
        if (!les){
          // fallback via agenda.json
          try{
            const agenda = await fetchJson('/data/agenda.json');
            les = (agenda||[]).find(x=>String(x.id)===String(id) && (x.type||'les')==='les');
          }catch{}
        }
        if (!les){ box.innerHTML = `<p class="error">Les met id <code>${escapeHtml(id)}</code> niet gevonden.</p>`; return; }

        // relaties
        const trainersById = new Map((all.trainers||[]).map(t=>[String(t.id), t]));
        const locatiesById = new Map((all.locaties||[]).map(l=>[String(l.id), l]));
        const reeksenById  = new Map((all.reeksen||[]).map(r=>[String(r.id), r]));

        // multi-trainer support
        const trainerIds = Array.isArray(les.trainerIds) ? les.trainerIds
                         : (les.trainerId!=null ? [les.trainerId] : []);
        const trainerObjs = trainerIds.map(id => trainersById.get(String(id))).filter(Boolean);

        // locatie
        const loc = (les.locatieId!=null) ? locatiesById.get(String(les.locatieId)) : null;
        const maps = buildMapsUrl(loc) || les.mapsUrl;

        // reeks
        const reeks = (les.reeksId!=null) ? reeksenById.get(String(les.reeksId)) : null;

        // header
        box.innerHTML = `
          <h2 style="margin:.25rem 0 0">${escapeHtml(les.naam || (reeks?.naam || 'Les'))}</h2>
          ${reeks?.type ? `<div class="meta">Type: ${escapeHtml(reeks.type)}</div>`:''}
          ${les.thema ? `<div class="meta">Thema: ${escapeHtml(les.thema)}</div>`:''}
        `;

        // details
        const rows = [];
        rows.push(`<tr><th style="width:180px">Datum & tijd</th><td>${humanDate(les.datum?.length<=10 ? `${les.datum}T${les.start||'00:00'}` : les.datum)}${les.einde?` ‚Äì ${pad2(les.einde.split(':')[0]||'')}:${pad2(les.einde.split(':')[1]||'')}`:''}</td></tr>`);
        rows.push(`<tr><th>Locatie</th><td>${loc ? (maps?`<a href="${maps}" target="_blank" rel="noopener">${escapeHtml(loc.naam)}</a>`:escapeHtml(loc.naam)) : escapeHtml(les.locatie||'‚Äî')}</td></tr>`);
        rows.push(`<tr><th>Trainer(s)</th><td>${trainerObjs.length ? `<div class="chips">${trainerObjs.map(t=>chip(`${t.voornaam||''} ${t.achternaam||''}`.trim())).join(' ')}</div>` : escapeHtml(les.trainer || '‚Äî')}</td></tr>`);
        if (reeks) rows.push(`<tr><th>Reeks</th><td><a href="/lessenreeks/detail.html?id=${encodeURIComponent(reeks.id)}">${escapeHtml(reeks.naam)}</a></td></tr>`);
        rows.push(`<tr><th>Capaciteit</th><td>${Number(les.capaciteit ?? reeks?.maxDeelnemers ?? 0) || '‚Äî'}</td></tr>`);
        tbody.innerHTML = rows.join('');

        notes.textContent = (reeks?.omschrijving || '').trim() || 'Geen extra notities.';
      }catch(e){
        box.innerHTML = `<p class="error">Fout bij laden: ${S(e.message)}</p>`;
      }
    })();
  })();
</script>
</body>
</html>
