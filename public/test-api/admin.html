<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Superhond ‚Äì Admin API Test</title>
  <style>
    :root { --ink:#111; --muted:#6b7280; --err:#b91c1c; --ok:#15803d; --border:#e5e7eb; --bg:#fafafa; }
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,sans-serif; background:var(--bg); color:var(--ink); padding:2rem; max-width:1100px; margin:0 auto; }
    h1 { margin:0 0 .75rem; }
    h2 { margin:.25rem 0 .5rem }
    h3 { margin-top:0 }
    .card { background:#fff; border:1px solid var(--border); border-radius:10px; box-shadow:0 1px 2px rgba(0,0,0,.06); padding:1rem 1.25rem; margin:0 0 1rem; }
    .row { display:flex; gap:.5rem; align-items:center; flex-wrap:wrap; margin:.25rem 0; }
    label { font-size:.9rem; color:var(--muted); }
    input,button { font:inherit; }
    input { min-width:280px; padding:.55rem .65rem; border:1px solid #d1d5db; border-radius:8px; background:#fff; }
    button { padding:.55rem .75rem; border:1px solid #d1d5db; border-radius:8px; background:#fff; cursor:pointer; }
    button.primary { background:#2563eb; border-color:#2563eb; color:#fff; }
    button:hover { background:#f3f4f6; }
    pre { background:#f9fafb; border:1px solid var(--border); border-radius:8px; padding:.75rem; overflow:auto; font-size:.9rem; max-height:50vh }
    .ok{ color:var(--ok); } .fail{ color:var(--err); } .muted{ color:var(--muted); }
    .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:1rem; }
    @media (max-width:900px){ .grid2{ grid-template-columns:1fr; } }
  </style>
</head>
<body>
  <h1>üõ°Ô∏è Superhond ‚Äì Admin API Test</h1>
  <p class="muted">Beheer hier zowel de <strong>centrale serverconfig</strong> (<code>/api/config</code>) als de <strong>GAS-acties</strong> via proxy (<code>/api/sheets</code>).</p>

  <!-- ====== Centrale serverconfig ====== -->
  <section class="card">
    <h2>1) Centrale Config (server)</h2>
    <div class="row">
      <button id="btnSrvCfgGet">/api/config ‚Üí ophalen</button>
      <span id="srvCfgState" class="muted">‚Äî</span>
    </div>
    <div class="row">
      <label>apiBase</label>
      <input id="srvApiBase" placeholder="https://script.google.com/macros/s/‚Ä¶/exec" />
      <button id="btnSrvCfgSet" class="primary">/api/config/set ‚Üí opslaan (centraal)</button>
    </div>
  </section>

  <!-- ====== GAS Config via proxy (bestaand) ====== -->
  <section class="card">
    <h2>2) GAS Config via proxy (cfg.get/cfg.set)</h2>
    <div class="row">
      <button id="btnCfgGet">cfg.get</button>
      <span id="cfgState" class="muted">‚Äî</span>
    </div>
    <div class="row">
      <label>apiBase</label>
      <input id="apiBase" placeholder="https://script.google.com/macros/s/‚Ä¶/exec" />
      <label>CFG_TOKEN</label>
      <input id="cfgToken" placeholder="token" />
      <button id="btnCfgSet">cfg.set (GAS)</button>
    </div>
  </section>

  <!-- ====== Schema ====== -->
  <section class="card">
    <h2>3) Schema (via proxy)</h2>
    <div class="row">
      <button id="btnSchemaGet">schema.get</button>
      <button id="btnEnsureAll">ensureSchema (alle tabs)</button>
      <span class="muted">Token vereist voor mutaties</span>
    </div>

    <div class="grid2">
      <div class="card" style="margin:0">
        <h3>Kolommen toevoegen (ensure)</h3>
        <div class="row"><input id="ensTab" placeholder="Tab (bv. Klanten)" /></div>
        <div class="row"><input id="ensCols" placeholder="Kolommen, komma-gescheiden (bv. iban,geboortedatum)" /></div>
        <div class="row">
          <input id="ensToken" placeholder="CFG_TOKEN" />
          <button id="btnEnsure">Uitvoeren</button>
        </div>
      </div>

      <div class="card" style="margin:0">
        <h3>Kolom hernoemen (rename)</h3>
        <div class="row"><input id="renTab" placeholder="Tab (bv. Klanten)" /></div>
        <div class="row">
          <input id="renFrom" placeholder="Van (oude headernaam)" />
          <input id="renTo" placeholder="Naar (nieuwe headernaam)" />
        </div>
        <div class="row">
          <input id="renToken" placeholder="CFG_TOKEN" />
          <button id="btnRename">Uitvoeren</button>
        </div>
      </div>
    </div>
  </section>

  <!-- ====== Output ====== -->
  <section class="card">
    <h2>Output</h2>
    <div id="status" class="muted">Klaar voor test‚Ä¶</div>
    <pre id="out">‚Äî</pre>
  </section>

  <script type="module">
    const $ = s => document.querySelector(s);
    const out = $('#out'), statusEl = $('#status');

    const show = (data, ok=true, title='Resultaat') => {
      statusEl.textContent = (ok ? '‚úîÔ∏è ' : '‚ùå ') + title;
      statusEl.className = ok ? 'ok' : 'fail';
      out.textContent = JSON.stringify(data, null, 2);
    };
    const getJSON = async (url, init) => {
      const r = await fetch(url, init);
      const txt = await r.text();
      let j; try { j = JSON.parse(txt); } catch { j = { raw: txt }; }
      return { ok: r.ok && j?.ok !== false, status: r.status, data: j };
    };
    const isExec = u => /^https:\/\/script\.google\.com\/macros\/s\/[^/]+\/exec(?:\?.*)?$/.test(String(u||'').trim());

    /* ====== 1) SERVER CONFIG ====== */
    const srvState = $('#srvCfgState');
    $('#btnSrvCfgGet').addEventListener('click', async ()=>{
      srvState.textContent = '‚è≥';
      const res = await getJSON('/api/config', { cache:'no-store' });
      if (res.ok) {
        $('#srvApiBase').value = res.data?.apiBase || '';
        srvState.textContent = 'OK'; srvState.className = 'ok';
        show(res.data, true, '/api/config');
      } else {
        srvState.textContent = 'FOUT'; srvState.className = 'fail';
        show(res.data, false, '/api/config');
      }
    });

    $('#btnSrvCfgSet').addEventListener('click', async ()=>{
      const val = $('#srvApiBase').value.trim();
      if (!isExec(val)) { srvState.textContent = 'Ongeldige /exec URL'; srvState.className='fail'; return; }
      srvState.textContent = '‚è≥';
      const res = await getJSON('/api/config/set', {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify({ apiBase: val })
      });
      if (res.ok && (res.data?.ok || res.data?.apiBase)) {
        srvState.textContent = 'Centraal gezet ‚úîÔ∏è'; srvState.className = 'ok';
        show(res.data, true, '/api/config/set');
      } else {
        srvState.textContent = 'FOUT'; srvState.className = 'fail';
        show(res.data, false, '/api/config/set');
      }
    });

    /* ====== 2) GAS CONFIG VIA PROXY (bestaand) ====== */
    const cfgState = $('#cfgState');
    $('#btnCfgGet').addEventListener('click', async ()=>{
      cfgState.textContent='‚è≥';
      const res = await getJSON('/api/sheets?action=cfg.get', { cache:'no-store' });
      if (res.ok) {
        const data = res.data?.data ?? res.data;
        $('#apiBase').value = data?.apiBase || '';
        cfgState.textContent='OK'; cfgState.className='ok';
        show(data, true, 'cfg.get');
      } else {
        cfgState.textContent='FOUT'; cfgState.className='fail';
        show(res.data, false, 'cfg.get');
      }
    });

    $('#btnCfgSet').addEventListener('click', async ()=>{
      const apiBase = $('#apiBase').value.trim();
      const token   = $('#cfgToken').value.trim();
      if (!isExec(apiBase)) return show({error:'Ongeldige /exec URL'}, false, 'cfg.set');
      const body = { entity:'Config', action:'set', payload:{ apiBase, token } };
      const res = await getJSON('/api/sheets', {
        method:'POST', headers:{ 'Content-Type':'text/plain' }, body: JSON.stringify(body)
      });
      show(res.data?.data ?? res.data, res.ok, 'cfg.set');
    });

    /* ====== 3) SCHEMA VIA PROXY ====== */
    $('#btnSchemaGet').addEventListener('click', async ()=>{
      const res = await getJSON('/api/sheets?action=schema.get', { cache:'no-store' });
      show(res.data?.data ?? res.data, res.ok, 'schema.get');
    });

    $('#btnEnsureAll').addEventListener('click', async ()=>{
      const token = prompt('CFG_TOKEN voor ensureAll:')?.trim() || '';
      const body = { entity:'Schema', action:'ensureAll', payload:{ token } };
      const res = await getJSON('/api/sheets', {
        method:'POST', headers:{ 'Content-Type':'text/plain' }, body: JSON.stringify(body)
      });
      show(res.data?.data ?? res.data, res.ok, 'schema.ensureAll');
    });

    $('#btnEnsure').addEventListener('click', async ()=>{
      const tab = $('#ensTab').value.trim();
      const cols = $('#ensCols').value.split(',').map(s=>s.trim()).filter(Boolean);
      const token = $('#ensToken').value.trim();
      const body = { entity:'Schema', action:'ensure', payload:{ tab, columns: cols, token } };
      const res = await getJSON('/api/sheets', {
        method:'POST', headers:{ 'Content-Type':'text/plain' }, body: JSON.stringify(body)
      });
      show(res.data?.data ?? res.data, res.ok, 'schema.ensure');
    });

    $('#btnRename').addEventListener('click', async ()=>{
      const tab  = $('#renTab').value.trim();
      const from = $('#renFrom').value.trim();
      const to   = $('#renTo').value.trim();
      const token= $('#renToken').value.trim();
      const body = { entity:'Schema', action:'rename', payload:{ tab, from, to, token } };
      const res = await getJSON('/api/sheets', {
        method:'POST', headers:{ 'Content-Type':'text/plain' }, body: JSON.stringify(body)
      });
      show(res.data?.data ?? res.data, res.ok, 'schema.rename');
    });

    // Auto-load serverconfig bij openen
    document.getElementById('btnSrvCfgGet').click();
  </script>
</body>
</html>
