<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Superhond — Dashboard</title>

  <!-- Centrale UI -->
  <link rel="stylesheet" href="../css/style.css?v=0.20.0" />
  <link rel="stylesheet" href="../css/superhond.css?v=0.20.0" />

  <!-- SEO/crawlers: dit is de echte pagina -->
  <meta name="robots" content="index, follow" />
  <meta name="theme-color" content="#0a7" />
  <meta name="color-scheme" content="light dark" />

  <!-- Optioneel ingestelde GAS /exec URL (fallback). Laat leeg als je via proxy gaat. -->
  <script>
    window.SUPERHOND_SHEETS_URL = window.SUPERHOND_SHEETS_URL || '';
  </script>

  <style>
    :root { color-scheme: light dark; }
    .tabs { display:flex; gap:.5rem; margin:1rem 0; flex-wrap:wrap }
    .tab { position:relative; padding:.45rem .8rem; border:1px solid #e5e7eb; border-radius:.5rem; background:#fff; cursor:pointer }
    .tab.active { background:var(--accent,#f4c400); font-weight:600 }
    .tab .dot { position:absolute; top:-6px; right:-6px; min-width:18px; height:18px; padding:0 6px; display:inline-flex; align-items:center; justify-content:center; border-radius:999px; font-size:11px; line-height:1; background:#111827; color:#fff }
    .muted { color:#6b7280 }
    .error { color:#b91c1c }
    .tile.badged { position:relative }
    .tile .badge-dot {
      position:absolute; top:8px; right:10px; min-width:22px; height:22px; padding:0 6px;
      display:inline-flex; align-items:center; justify-content:center;
      border-radius:999px; font-size:12px; line-height:1;
      background:var(--accent,#f4c400); color:#000; border:1px solid rgba(0,0,0,.08);
      box-shadow:0 1px 2px rgba(0,0,0,.08);
    }
  </style>
</head>
<body class="dashboard-page">
  <header id="topbar" class="topbar"></header>

  <main class="container">
    <h1 class="page-title">Hoofdmenu</h1>

    <!-- TEGELS -->
    <nav class="tiles" aria-label="Hoofdmenu">
      <a class="tile" href="../klanten/"><span aria-hidden="true">👤</span> Klanten</a>
      <a class="tile" href="../honden/"><span aria-hidden="true">🐶</span> Honden</a>
      <a class="tile" href="../strippenkaarten/"><span aria-hidden="true">🎫</span> Strippenkaarten</a>

      <a class="tile badged" href="../lessen/">
        <span aria-hidden="true">📅</span>
        <div class="tile-body">
          <span class="tile-title">Lessen</span>
          <span class="tile-sub" id="lessen-week-sub">—</span>
        </div>
        <span class="badge-dot" id="lessen-week-badge" aria-label="Aantal lessen">0</span>
      </a>

      <!-- 📚 Klassen -->
      <a class="tile badged" href="../klassen/">
        <span aria-hidden="true">📚</span>
        <div class="tile-body">
          <span class="tile-title">Klassen</span>
          <span class="tile-sub" id="klassen-sub">—</span>
        </div>
        <span class="badge-dot" id="klassen-badge" aria-label="Aantal actieve klassen">0</span>
      </a>

      <!-- 📦 Lessenreeksen -->
      <a class="tile badged" href="../lessenreeks/">
        <span aria-hidden="true">📦</span>
        <div class="tile-body">
          <span class="tile-title">Lessenreeksen</span>
          <span class="tile-sub" id="reeksen-sub">—</span>
        </div>
        <span class="badge-dot" id="reeksen-badge" aria-label="Aantal actieve reeksen">0</span>
      </a>

      <a class="tile" href="../mededeling/"><span aria-hidden="true">📢</span> Mededelingen</a>
      <a class="tile" href="../trainers/"><span aria-hidden="true">🧑‍🏫</span> Trainers</a>
      <a class="tile" href="../rapporten/"><span aria-hidden="true">📈</span> Rapporten</a>
      <a class="tile" href="../instellingen/"><span aria-hidden="true">⚙️</span> Instellingen</a>
      <a class="tile" href="../over/"><span aria-hidden="true">ℹ️</span> Over</a>
      <a class="tile" href="../lessen/beheer.html"><span aria-hidden="true">⚙️</span> Lessenbeheer</a>
    </nav>

    <!-- AGENDA -->
    <section class="card" style="margin-top:1rem">
      <h2 style="margin:0 0 .5rem">Agenda</h2>

      <div class="tabs" id="agenda-tabs" role="tablist" aria-label="Agenda tabs">
        <button class="tab active" data-tab="week" role="tab" aria-selected="true" tabindex="0">
          Deze week <span class="dot" id="tab-week-dot">0</span>
        </button>
        <button class="tab" data-tab="alles" role="tab" aria-selected="false" tabindex="-1">
          Alles <span class="dot" id="tab-all-dot">0</span>
        </button>
        <button class="tab" data-tab="mededelingen" role="tab" aria-selected="false" tabindex="-1">
          Mededelingen <span class="dot" id="tab-notes-dot">0</span>
        </button>
      </div>

      <div id="agenda-loader" class="muted" role="status" aria-live="polite">⏳ Laden…</div>
      <div id="agenda-error" class="error" style="display:none" role="alert"></div>

      <div class="table-wrap" id="agenda-table-wrap" style="display:none;">
        <table id="agenda-table" class="table">
          <thead>
            <tr><th>Naam</th><th>Datum</th><th>Locatie</th><th>Trainer(s)</th></tr>
          </thead>
          <tbody><!-- gevuld door ../js/agenda.js --></tbody>
        </table>
      </div>
    </section>
  </main>

  <footer id="footer" class="footer"></footer>

  <!-- Basis scripts -->
  <script src="../js/layout.js?v=0.20.0" defer></script>
  <script src="../js/agenda.js?v=0.20.0" defer></script>

  <!-- Dashboard init -->
  <script type="module">
    // Robuuste import helper
    const safeImport = async (path) => {
      try { return await import(path); }
      catch (e) { console.error(`Import mislukt: ${path}`, e); return {}; }
    };

    // Probeer config-gedreven base discovery → fallback naar window var
    async function resolveSheetsBase() {
      try {
        const r = await fetch('../../api/config', { cache: 'no-store' });
        if (r.ok) {
          const cfg = await r.json();
          if (cfg?.apiBase) return String(cfg.apiBase);
        }
      } catch {/* ignore */}
      return window.SUPERHOND_SHEETS_URL || '';
    }

    const sheets = await safeImport('../js/sheets.js');
    const store  = await safeImport('../js/store.js');

    const { setBaseUrl, fetchSheet, normStatus } = {
      setBaseUrl: sheets.setBaseUrl || (() => {}),
      fetchSheet: sheets.fetchSheet || (async () => { throw new Error('sheets.fetchSheet ontbreekt'); }),
      normStatus: sheets.normStatus || ((s) => String(s||'').toLowerCase())
    };

    const {
      ensureMigrated = () => {},
      getKlassen = () => [],
      getReeksen = () => [],
      isActiefStatus = (s) => String(s||'').toLowerCase() === 'actief'
    } = store;

    // Zet base URL voor sheets: /api/config → apiBase → fallback window var
    const baseUrl = await resolveSheetsBase();
    if (baseUrl) setBaseUrl(baseUrl);

    function labelActief(n) {
      if (n === 0) return 'geen actief';
      if (n === 1) return '1 actief';
      return `${n} actief`;
    }

    function setBadges(klCount, rsCount){
      const kc = document.getElementById('klassen-badge');
      const ks = document.getElementById('klassen-sub');
      const rc = document.getElementById('reeksen-badge');
      const rs = document.getElementById('reeksen-sub');
      if (kc) kc.textContent = String(klCount);
      if (ks) ks.textContent = labelActief(klCount);
      if (rc) rc.textContent = String(rsCount);
      if (rs) rs.textContent = labelActief(rsCount);
    }

    async function updateBadges() {
      // 1) probeer Sheets (remote)
      try {
        const [klassen, reeksen] = await Promise.all([
          fetchSheet('Klassen'),
          fetchSheet('Reeksen'),
        ]);
        const actKl = (klassen || []).filter(k => normStatus(k.status) === 'actief').length;
        const actRs = (reeksen || []).filter(r => normStatus(r.status) === 'actief').length;
        setBadges(actKl, actRs);
        return;
      } catch (e) {
        console.warn('Sheets-laden faalde, val terug op local store:', e?.message || e);
      }

      // 2) fallback: lokale buckets
      try {
        ensureMigrated();
        const actKl = (getKlassen() || []).filter(k => isActiefStatus(k.status)).length;
        const actRs = (getReeksen() || []).filter(r => isActiefStatus(r.status)).length;
        setBadges(actKl, actRs);
      } catch (e) {
        console.error('Badges updaten mislukt:', e);
      }
    }

    // Tabs: minimale a11y
    function initTabs() {
      const tabs = Array.from(document.querySelectorAll('#agenda-tabs .tab'));
      const setActive = (btn) => {
        tabs.forEach(t => {
          const on = t === btn;
          t.classList.toggle('active', on);
          t.setAttribute('aria-selected', on ? 'true' : 'false');
          t.setAttribute('tabindex', on ? '0' : '-1');
        });
      };
      tabs.forEach(t => t.addEventListener('click', () => setActive(t)));
      tabs.forEach(t => t.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowRight' || e.key === 'ArrowLeft') {
          e.preventDefault();
          const i = tabs.indexOf(document.activeElement);
          const dir = e.key === 'ArrowRight' ? 1 : -1;
          const next = tabs[(i + dir + tabs.length) % tabs.length];
          next.focus(); setActive(next);
        }
      }));
    }

    document.addEventListener('DOMContentLoaded', () => {
      if (window.SuperhondUI?.mount) {
        SuperhondUI.mount({ title: 'Superhond', icon: '🐾', home: true });
      }
      initTabs();
      updateBadges();
    });
  </script>

  <noscript>
    <p style="padding:1rem;color:#b91c1c">JavaScript is vereist om het dashboard te laden.</p>
  </noscript>
</body>
</html>
