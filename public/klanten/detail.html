<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Klant detail ‚Äì Superhond</title>

  <!-- RELATIEF naar css -->
  <link rel="stylesheet" href="../css/style.css?v=0.19.2" />
  <link rel="stylesheet" href="../css/superhond.css?v=0.19.2" />
</head>
<body>
  <!-- Topbar -->
  <header id="topbar" class="topbar"></header>

  <main class="container">
    <h2 class="page-title">Klant detail</h2>
    <div id="box" class="card">‚è≥ Bezig met laden‚Ä¶</div>
    <!-- RELATIEVE teruglink -->
    <p><a href="./" class="btn">‚Üê Terug naar klanten</a></p>
  </main>

  <!-- Footer -->
  <footer id="footer" class="footer"></footer>

  <!-- Layout (RELATIEF) -->
  <script src="../js/layout.js?v=0.19.2"></script>
  <script>
    // Topbar/footer
    window.addEventListener('DOMContentLoaded', () => {
      if (window.SuperhondUI?.mount) {
        // back wijst naar de map zelf
        SuperhondUI.mount({ title:'Klant detail', icon:'üë§', back:'./' });
      }
    });

    const S = v => String(v ?? '');
    const params = new URLSearchParams(location.search);
    const id = params.get('id');
    const target = document.getElementById('box');

    const bust = () => '?t=' + Date.now();

    function fmtAdres(k = {}) {
      const p1 = [k.straat, [k.huisnr, k.bus].filter(Boolean).join('')].filter(Boolean).join(' ');
      const p2 = [k.postcode, k.gemeente].filter(Boolean).join(' ');
      return [p1, p2].filter(Boolean).join(', ') || '‚Äî';
    }
    function naamVan(k = {}) {
      const comb = [k.voornaam, k.achternaam].filter(Boolean).join(' ').trim();
      return comb || k.naam || S(k.email).split('@')[0] || '(zonder naam)';
    }

    async function fetchJson(tryUrls) {
      for (const u of tryUrls) {
        const r = await fetch(u + bust(), { cache: 'no-store' });
        if (r.ok) return r.json();
      }
      throw new Error('Geen data-bron bereikbaar ('+ tryUrls.join(', ') +')');
    }

    async function load() {
      if (!id) {
        target.innerHTML = '<p class="error">Geen <code>id</code> opgegeven.</p>';
        return;
      }
      try {
        // API ‚Üí fallback data (RELATIEF)
        const [klanten, honden] = await Promise.all([
          fetchJson(['../api/klanten', '../data/klanten.json']),
          fetchJson(['../api/honden',  '../data/honden.json'])
        ]);

        const klant = (klanten || []).find(k => String(k.id) === String(id));
        if (!klant) {
          target.innerHTML = `<p class="error">Klant met id <code>${S(id)}</code> niet gevonden.</p>`;
          return;
        }

        const naam = naamVan(klant);
        const hondenVanKlant = (honden || [])
          .filter(h => String(h.eigenaarId ?? h.klantId ?? h.ownerId) === String(klant.id))
          .sort((a,b) => S(a.naam).localeCompare(S(b.naam)));

        target.innerHTML = `
          <h3 style="margin-top:0">${naam}</h3>
          <div class="grid" style="display:grid;gap:1rem;grid-template-columns:1fr">
            <section>
              <ul>
                <li><strong>E-mail:</strong> ${S(klant.email) || '‚Äî'}</li>
                <li><strong>Telefoon:</strong> ${S(klant.telefoon) || '‚Äî'}</li>
                <li><strong>Adres:</strong> ${fmtAdres(klant)}</li>
                <li><strong>Land:</strong> ${S(klant.land) || '‚Äî'}</li>
              </ul>
            </section>
            <section>
              <h4>Honden van deze klant</h4>
              ${
                hondenVanKlant.length
                  ? `<ul>${hondenVanKlant.map(h => `
                       <li><a href="../honden/detail.html?id=${encodeURIComponent(h.id)}">${S(h.naam)}</a></li>
                     `).join('')}</ul>`
                  : '<p class="muted">Geen honden gekoppeld.</p>'
              }
            </section>
          </div>
        `;
      } catch (e) {
        console.error(e);
        target.innerHTML = `<p class="error">‚ö†Ô∏è Kon klantgegevens niet laden. ${S(e.message)}</p>`;
      }
    }

    load();
  </script>
</body>
</html>
