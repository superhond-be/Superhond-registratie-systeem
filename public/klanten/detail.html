<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Klant detail ‚Äì Superhond</title>

  <link rel="stylesheet" href="../css/style.css?v=0.22.5" />
  <link rel="stylesheet" href="../css/superhond.css?v=0.22.5" />
</head>
<body class="subpage">
  <!-- Topbar -->
  <header id="topbar" class="topbar"></header>

  <main class="container" role="main">
    <h1 class="page-title">Klant detail</h1>
    <article id="box" class="card" aria-live="polite">‚è≥ Bezig met laden‚Ä¶</article>
    <p><a href="./" class="btn" aria-label="Terug naar klanten">‚Üê Terug naar klanten</a></p>
  </main>

  <!-- Footer -->
  <footer id="footer" class="footer" role="contentinfo"></footer>

  <!-- Layout (centrale config + UI) -->
  <script src="../js/layout.js?v=0.22.5" defer></script>

  <!-- Paginalogica -->
  <script type="module">
    import { ensureMigrated, getKlanten, getHonden } from "../js/store.js";

    /* ---------- helpers ---------- */
    const S = v => String(v ?? "");
    const T = v => S(v).trim();
    const esc = s => S(s)
      .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;").replace(/'/g,"&#39;");

    const params = new URLSearchParams(location.search);
    const id     = params.get("id");
    const target = document.getElementById("box");

    function cacheBust(url){
      try { const u = new URL(url, location.origin); u.searchParams.set("t", Date.now()); return u.toString(); }
      catch { return url + (url.includes("?") ? "&" : "?") + "t=" + Date.now(); }
    }

    async function fetchJson(tryUrls, { timeout = 9000 } = {}) {
      for (const base of tryUrls) {
        const url = cacheBust(base);
        const ac = ("AbortController" in window) ? new AbortController() : null;
        const to = ac ? setTimeout(() => ac.abort(), timeout) : null;
        try {
          const r = await fetch(url, { cache: "no-store", signal: ac?.signal });
          if (r.ok) {
            const j = await r.json().catch(() => null);
            if (j) return j;
          }
        } catch (_) {}
        finally { if (to) clearTimeout(to); }
      }
      return null;
    }

    function fmtAdres(k = {}) {
      const p1 = [T(k.straat), [T(k.huisnr), T(k.bus)].filter(Boolean).join("")].filter(Boolean).join(" ");
      const p2 = [T(k.postcode), T(k.gemeente)].filter(Boolean).join(" ");
      const out = [p1, p2].filter(Boolean).join(", ");
      return esc(out || "‚Äî");
    }

    function guessNameFromEmail(email){
      const local = T(email).split("@")[0];
      return local.split(/[._-]+/)
        .map(x => x ? x[0].toUpperCase() + x.slice(1) : "")
        .join(" ").trim();
    }

    function naamVan(k = {}) {
      const comb = [T(k.voornaam), T(k.achternaam)].filter(Boolean).join(" ").trim();
      if (comb) return esc(comb);
      if (T(k.naam)) return esc(k.naam);
      const fromMail = guessNameFromEmail(k.email);
      return esc(fromMail || "(zonder naam)");
    }

    function hondenVanKlant(honden, klantId){
      const idStr = String(klantId);
      return (honden || [])
        .map(h => ({
          ...h,
          eigenaarId: h.eigenaarId ?? h.eigenaar_id ?? h.ownerId ?? h.klantId ?? h.klant_id ?? ""
        }))
        .filter(h => String(h.eigenaarId) === idStr)
        .sort((a,b) => T(a.naam).localeCompare(T(b.naam)));
    }

    // mailto/tel helpers
    function mailtoHref(v){
      const s = T(v);
      return s && s.includes("@") ? `mailto:${s}` : "";
    }
    function normalizePhoneHref(v){
      let s = T(v);
      if (!s) return "";
      s = s.replace(/[^\d+]/g, "");
      if (s.startsWith("00")) s = "+" + s.slice(2);
      return s ? `tel:${s}` : "";
    }

    function renderDetail(klant, hondenList){
      const naam = naamVan(klant);
      const dogs = hondenVanKlant(hondenList, klant.id);

      const emailText = T(klant.email);
      const emailHref = mailtoHref(emailText);
      const emailHTML = emailHref
        ? `<a href="${esc(emailHref)}">${esc(emailText)}</a>`
        : (esc(emailText) || "‚Äî");

      const telText = T(klant.telefoon);
      const telHref = normalizePhoneHref(telText);
      const telHTML = telHref
        ? `<a href="${esc(telHref)}">${esc(telText)}</a>`
        : (esc(telText) || "‚Äî");

      target.innerHTML = `
        <h2 style="margin-top:0">${naam}</h2>
        <div class="grid" style="display:grid;gap:1rem;grid-template-columns:repeat(auto-fit,minmax(260px,1fr))">
          <section>
            <ul>
              <li><strong>E-mail:</strong> ${emailHTML}</li>
              <li><strong>Telefoon:</strong> ${telHTML}</li>
              <li><strong>Adres:</strong> ${fmtAdres(klant)}</li>
              <li><strong>Land:</strong> ${esc(T(klant.land)) || "‚Äî"}</li>
            </ul>
          </section>

          <section>
            <h3>Honden van deze klant</h3>
            ${
              dogs.length
                ? `<ul>${
                    dogs.map(h => `
                      <li>
                        <a href="../honden/detail.html?id=${encodeURIComponent(h.id)}">
                          ${esc(T(h.naam) || "Hond")}
                        </a>
                      </li>`).join("")
                  }</ul>`
                : '<p class="muted">Geen honden gekoppeld.</p>'
            }
          </section>
        </div>
      `;
    }

    async function load() {
      // Topbar/footer mount
      if (window.SuperhondUI?.mount) {
        SuperhondUI.mount({ title: "Klant detail", icon: "üë§", back: "./", showApiStatus: false });
      }

      if (!id) {
        target.innerHTML = '<p class="error">Geen <code>id</code> opgegeven.</p>';
        return;
      }

      try {
        // 1) Snelpad: buckets (localStorage)
        await ensureMigrated();
        let klanten = getKlanten() || [];
        let honden  = getHonden()  || [];

        // 2) Centrale API-config ‚Üí proxy ‚Üí statische demo
        const apiBase = (window.SuperhondConfig?.getApiBaseSync?.() || "").trim();

        if (!klanten.length) {
          const cands = [];
          if (apiBase) cands.push(`${apiBase}?mode=klanten`);
          cands.push("/api/sheets?mode=klanten");
          cands.push("../data/klanten.json", "/data/klanten.json");
          const js = await fetchJson(cands);
          if (Array.isArray(js)) klanten = js;
          else if (Array.isArray(js?.items)) klanten = js.items;
          else if (Array.isArray(js?.data))  klanten = js.data;
        }

        if (!honden.length) {
          const cands = [];
          if (apiBase) cands.push(`${apiBase}?mode=honden`);
          cands.push("/api/sheets?mode=honden");
          cands.push("../data/honden.json", "/data/honden.json");
          const jh = await fetchJson(cands);
          if (Array.isArray(jh)) honden = jh;
          else if (Array.isArray(jh?.items)) honden = jh.items;
          else if (Array.isArray(jh?.data))  honden = jh.data;
        }

        const klant = (klanten || []).find(x => String(x?.id) === String(id));
        if (!klant) {
          target.innerHTML = `<p class="error">Klant met id <code>${esc(id)}</code> niet gevonden.</p>`;
          return;
        }

        renderDetail(klant, honden);

      } catch (e) {
        console.error(e);
        target.innerHTML = `<p class="error">‚ö†Ô∏è Kon klantgegevens niet laden. ${esc(e?.message || e)}</p>`;
      }
    }

    document.addEventListener("DOMContentLoaded", load);
  </script>
</body>
</html>
