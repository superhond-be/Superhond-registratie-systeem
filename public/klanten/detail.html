<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Klant detail ‚Äì Superhond</title>

  <link rel="stylesheet" href="../css/style.css?v=0.20.0" />
  <link rel="stylesheet" href="../css/superhond.css?v=0.20.0" />
</head>
<body>
  <!-- Topbar -->
  <header id="topbar" class="topbar"></header>

  <main class="container">
    <h2 class="page-title">Klant detail</h2>
    <div id="box" class="card">‚è≥ Bezig met laden‚Ä¶</div>
    <p><a href="./" class="btn">‚Üê Terug naar klanten</a></p>
  </main>

  <!-- Footer -->
  <footer id="footer" class="footer"></footer>

  <!-- Layout -->
  <script src="../js/layout.js?v=0.20.0" defer></script>

  <!-- Paginalogica -->
  <script type="module">
    import { ensureMigrated, getKlanten, getHonden } from "../js/store.js";

    /* ---------- helpers ---------- */
    const S = v => String(v ?? "");
    const T = v => S(v).trim();
    const esc = s => S(s)
      .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;").replace(/'/g,"&#39;");

    const params = new URLSearchParams(location.search);
    const id     = params.get("id");
    const target = document.getElementById("box");

    const bust = () => "?t=" + Date.now();

    function fmtAdres(k = {}) {
      const p1 = [T(k.straat), [T(k.huisnr), T(k.bus)].filter(Boolean).join("")].filter(Boolean).join(" ");
      const p2 = [T(k.postcode), T(k.gemeente)].filter(Boolean).join(" ");
      const out = [p1, p2].filter(Boolean).join(", ");
      return esc(out || "‚Äî");
    }

    function naamVan(k = {}) {
      const comb = [T(k.voornaam), T(k.achternaam)].filter(Boolean).join(" ").trim();
      if (comb) return esc(comb);
      if (T(k.naam)) return esc(k.naam);
      const fromMail = T(k.email).split("@")[0] || "";
      return esc(fromMail || "(zonder naam)");
    }

    async function fetchJson(tryUrls) {
      for (const u of tryUrls) {
        try {
          const r = await fetch(u + bust(), { cache: "no-store" });
          if (r.ok) return r.json();
        } catch (_) {}
      }
      return null;
    }

    function findById(list, id){
      return (list || []).find(x => String(x?.id) === String(id));
    }

    function hondenVanKlant(honden, klantId){
      return (honden || [])
        .filter(h => String(h.eigenaarId ?? h.klantId ?? h.ownerId) === String(klantId))
        .sort((a,b) => T(a.naam).localeCompare(T(b.naam)));
    }

    function renderDetail(klant, hondenList){
      const naam = naamVan(klant);
      const dogs = hondenVanKlant(hondenList, klant.id);

      target.innerHTML = `
        <h3 style="margin-top:0">${naam}</h3>
        <div class="grid" style="display:grid;gap:1rem;grid-template-columns:1fr">
          <section>
            <ul>
              <li><strong>E-mail:</strong> ${esc(T(klant.email)) || "‚Äî"}</li>
              <li><strong>Telefoon:</strong> ${esc(T(klant.telefoon)) || "‚Äî"}</li>
              <li><strong>Adres:</strong> ${fmtAdres(klant)}</li>
              <li><strong>Land:</strong> ${esc(T(klant.land)) || "‚Äî"}</li>
            </ul>
          </section>

          <section>
            <h4>Honden van deze klant</h4>
            ${
              dogs.length
                ? `<ul>${
                    dogs.map(h => `
                      <li>
                        <a href="../honden/detail.html?id=${encodeURIComponent(h.id)}">
                          ${esc(T(h.naam) || "Hond")}
                        </a>
                      </li>`).join("")
                  }</ul>`
                : '<p class="muted">Geen honden gekoppeld.</p>'
            }
          </section>
        </div>
      `;
    }

    async function load() {
      // Topbar/footer mount
      if (window.SuperhondUI?.mount) {
        SuperhondUI.mount({ title: "Klant detail", icon: "üë§", back: "./" });
      }

      if (!id) {
        target.innerHTML = '<p class="error">Geen <code>id</code> opgegeven.</p>';
        return;
      }

      try {
        // 1) Snelpad: buckets (localStorage)
        ensureMigrated();
        let klanten = getKlanten() || [];
        let honden  = getHonden()  || [];

        // 2) Fallback naar API/JSON als buckets leeg zijn
        if (!klanten.length) {
          const js = await fetchJson(["../api/klanten","../data/klanten.json"]);
          if (Array.isArray(js)) klanten = js;
          else if (Array.isArray(js?.items)) klanten = js.items;
        }
        if (!honden.length) {
          const jh = await fetchJson(["../api/honden","../data/honden.json"]);
          if (Array.isArray(jh)) honden = jh;
          else if (Array.isArray(jh?.items)) honden = jh.items;
        }

        const klant = findById(klanten, id);
        if (!klant) {
          target.innerHTML = `<p class="error">Klant met id <code>${esc(id)}</code> niet gevonden.</p>`;
          return;
        }

        renderDetail(klant, honden);

      } catch (e) {
        console.error(e);
        target.innerHTML = `<p class="error">‚ö†Ô∏è Kon klantgegevens niet laden. ${esc(e.message || e)}</p>`;
      }
    }

    document.addEventListener("DOMContentLoaded", load);
  </script>
</body>
</html>
